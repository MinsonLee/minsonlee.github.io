---
layout: post
title: "谈谈 502 和 504 的排查"
date: 2020-05-21
tag: 数据库
---

502：由于上游服务返回错误，导致nginx响应了502；如：一瞬间流量过大，php-fpm的处理进程被占用满，有其他流量进入但是没有空余的php-fpm进程处理，因此nginx接收到报错返回了502
504：由于某些原因(如：php-fpm请求外部超时；或者php-fmp挂了之类的)，导致 nginx 等待超时

以下是我对两种情况的猜测：
1. 先502再504的情况：搜索流量突然猛增，导致php-fpm的进程被占满，进程不足处理不过来请求所以报502，然后导致服务器负载飙高，处理能力变低，从而使的正在处理的进程处理超时所以夹杂报504
2. 先504再到502的情况：供应商接口挂了导致请求超时，所以nginx先报504，大量php-fpm进程超时阻塞，使的php-fpm进程被耗尽，报错502

解决（基于猜测正确的情况）：
1. 先502再504的情况：这种要采取方式限制流量继续进入
2. 先504再502的情况：先kill掉阻塞的进程，排查对应的超时原因(如：确定某个供应商挂了，先下架这个供应商的搜索)

----
- 504系脚本执行超时：超过nginx的fastcgi设置的等待时间
- 502系服务器异常：服务器异常的原因好多

504之后出502：是504脚本过多，导致线上没有空闲cgi进程了，生产环境完全瘫痪了，后面就会出502。nginx自己有一个等待队列。当cgI进程都跑满，没有空闲进程处理新请求了。nginx会让新请求等待一下。等待超过设定时间了。出504。出502的代表是完全瘫痪了。nginx已经知道有一堆人等紧。后面继续涌入黎既人就干脆502了。

因为504是等待一段时间才出。会让客户端等待一段时间的。502是直接抛出的。不用等待

nginx貌似有健康检测。距有阀值评判线上健康情况。当大量的请求处于等待。超过阀值。甘样后面新进来的请求就无必要等待了。因为，系统已经瘫痪了。继续等只会让问题变得更加严重

出502是网关错误，502问题在cgi上。因为cgi就是网关，cgi发生任何问题。抛出非预期返回值。nginx就报502了
> 就好似你同前端对接接口甘。约定系json。突然返回个xml，就报502 code了,504就系距发现接口超过等待时间，就出504

lnmp架构下，fastcgi就是他们的通讯协议。

网关的角色，不只是局限为php的cgi。例如线上的模式，第一层nginx做转发，弟二层nginx做web。站在第一层nginx角度去睇。第二层nginx就是网关。客户端是用户浏览器

现在第二层nginx角色去看。网关是php。客户端是第一层nginx。

所以。如果是第二层nginx异常。例如两层nginx配置不统一。或者版本不统一。第二层nginx给第一层返回了不可预期的东西，一样是502。例如上次个客户端cookie过多。导致nginx报502，实际上，看kibana，第二层nginx是返回200状态码的。只是第一层nginx报502。是因为超过第一层nginx的设置的buffer了。第一层nginx有些职责配置。是第二层nginx没有的。例如果个proxy_xxxx之类的配置。因为职责不同。

502比504更加复杂，情况或者会有更多。502可以笼统说为，当网关出现问题了。nginx做兜底响应的状态码，告诉客户端，是cgi出问题了，不是我自己出问题了，至于cgi出什么问题，它是不知道的，因为cgi是通用协议，任何实现了cgi协议的客户端都可以做nginx的下游网关。

假如某个脚本把php进程去全耗光了。一样会出现大面积502的。
例如上次我说的那个opcache导致account域名502的问题，你有无睇到每访问一次就死一个进程，php-fpm的error log有一个exit code 1的日志，每访问一次就死一个。假如访问速度比php-fpm fork进程速度要快。甘样php-fpm进程池就耗光了，这种情况比较少见，一般系来自php底层异常了，上次果个系opcache的bug来的。官方文档有描述过，话如果设置果个自动检测的参数，会出现不可预料的问题。

还在体育中心上班那时，我跟继欣排查过一个搜索高峰大量502的问题，最终定位是gearman那个等待超时设置上，本来是等待3秒，但是不知道哪个傻逼写成3了，实际那个是毫秒参数。变成等待3毫秒就断开，高峰的时候gearman开始负载飙升，响应时间拉长，所以就会高峰出现502，平时不出现。当时我地排查问题好困难，因为个问题只在高峰出现，平时五出现。因为只有高峰的时候，gearman才会响应慢，大量gearman client超时断开，最终产生质变的502。我地最后系本地用siege并发请求测试环境模拟的，个问题排查左将近1个星期，nginx就报502.php-fpm日志出现signal 11错误，系大量gearman client超时断开，引发那个gearman扩展的bug（导出code dump来看的吗？），最终解决办法就系设置3秒。甘样就无甘大量超时，问题就解决了。

出现504。常见的情况：
- 一般系程序死循环
- 慢查询（所以点解我成日话mysql系短板，鬼叫所有硬件设备里面，最慢就系硬盘，就算系固态硬盘。都不及人地内存10%的速度，内存的速度貌似不及cpu速度的千分之一，在冯诺依曼计算机模型，硬盘永远系最慢的，所以，系存数据到硬盘的存储数据服务，肯定系业务短板，而且，数据又几乎系所有业务都需要的，所以，一旦mysq赖野。上层业务肯定全线赖野，五系点解要拆库。就是为了解决鸡蛋在一个篮子的问题）
> 所以裘大果个用mysql做限流器,系几甘傻逼,把自己最弱的一层，推去死了,限流本身就是大流量访问场景.限流当然是上层缓存去做的，甚至网关上做。
- 504还有一种常见的场景：缓存big key（一般表现为cloud watch上面，mysql异常的负载低。然后缓存的cpu占用超高==>脚本一般是先访问缓存，再访问mysql，缓存层处理超时，没到数据库层，火力都被缓存拉走了。自然mysql就无咩压力了）。
> 例如redis，单线程处理。一旦某个big key是热数据，经常被访问，自然每次取数据那时就特别慢。例如一个小key的读取时间是5ms，一个大key的读取时间是100ms。这样，量一大，自然就会慢。正如高速路上，5车道。正常跑小车，车速快，问题不大，但是突然某一天，很多货车在路上跑。货车的车速肯定没小车快，自然就有堵车风险了。但不一定会堵车，看时机的，例如5车道都跑满货车了。那能不堵车么？正如缓存big key，如果访问量大，也是会有慢查风险，规避big key，就要从源头开始，减少设计big key，将big key拆成多个key存。

大部分504围绕mysql和缓存big key存在。少部分系服务直接挂了。例如经常性504都系因为底层服务挂了导致的话，甘样就琳琳系咪要换家服务器提供商了，服务器提供商要保证服务器高可用的。大部分场景都系业务层导致的，少部分场景是底层服务器上面的问题。


- CGI(通用网关接口)：https://baike.baidu.com/item/CGI/607810
- 一文看懂nginx+php执行请求原理——cgi，php-cgi，fastcgi，phpfpm：https://baijiahao.baidu.com/s?id=1637483210158521104&wfr=spider&for=pc
- 别把CGI、FastCGI、PHP-CGI、PHP-FPM、Spawn-FCGI搞混了:https://mp.weixin.qq.com/s/PrqEkNJummqTft7LKKJauA
- CGI跟我学：https://www.jdon.com/idea/cgi.htm
- 万法归宗——CGI：https://zhuanlan.zhihu.com/p/25013398
- 简单说明CGI和动态请求是什么：https://www.cnblogs.com/f-ck-need-u/p/7627035.html



## 背景
`2020-05-21` 大约`23:00-23:15`时段，企业微信上突然收到主站搜索服务异常的报警，因为对搜索业务不熟悉于是立刻通知了供应商组的同事进行跟进，同时也协助并了解了一下对应的业务。
综合往常的服务异常报警邮件，发现了点问题：
- 旧站未优化时报警日志基本都是先提示`504`再到`502`
- 搜索服务异常时报警基本都是`502`

## 什么是`502`和`504`
对于这两个状态码应该是开发常常会遇到的，解释也基本都知道：
- `504-Gateway Timeout`：网关超时。
- `502 - Bad Gateway`：网关服务异常。通常并不意味着上有服务器已经关闭(无响应网关/代理)，而是上游服务器和网关/代理使用欧冠不一致的协议交换数据导致。



上述的两个解释

## 什么是`Gateway-网关`？

对于`LNMP`架构来说，一般都是因为`php`脚本的执行时长超过了`nginx`设置的`fastcgi`等待时间造成的。
